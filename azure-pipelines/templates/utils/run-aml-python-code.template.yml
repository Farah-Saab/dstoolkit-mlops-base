# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License.

# Azure Pipeline Template for running code that requires authentication to an AML workspace 

parameters:
- name: serviceConnection
  type: string
- name: resourceGroup
  type: string
- name: amlWorkspace
  type: string
- name: scriptPath
  type: string
- name: scriptArguments
  type: string
  default: ''
- name: scriptExtraDependencies
  type: string
  default: ''
- name: displayName
  type: string
  default: 'Run Python Code'

steps:

    - task: UsePythonVersion@0
      displayName: 'Use Python $(PYTHON_VERSION)'
      inputs:
        versionSpec: $(PYTHON_VERSION)
    # TODO: temporary fixed for bug in az cli 2.30 is corrected
    # Downgrade azure-devops 0.21.0 due to this error: https://github.com/microsoft/dstoolkit-mlops-base/issues/47
    - task: AzureCLI@1
      displayName: 'Downgrade azure-devops 0.21.0'
      inputs:
        azureSubscription: ${{parameters.serviceConnection}}
        scriptLocation: inlineScript
        inlineScript: |
          az extension remove --name azure-devops
          az extension add --name azure-devops --version 0.21.0

    # Downgrade az cli due to this error: https://github.com/microsoft/dstoolkit-mlops-base/issues/47
    - task: Bash@3
      displayName: "Bash: Downgrade AZ CLI to [2.29.2]"
      inputs:
        targetType: "inline"
        workingDirectory: "$(Build.SourcesDirectory)"
        script: |
          sudo add-apt-repository https://packages.microsoft.com/repos/azure-cli
          sudo apt update
          apt-cache policy azure-cli
          sudo apt install -y --allow-downgrades azure-cli=2.29.2-1~bionic

    - task: AzureCLI@1
      displayName: 'Generate AML Workspace Config File'
      inputs:
        azureSubscription: ${{parameters.serviceConnection}}
        scriptLocation: inlineScript
        inlineScript: |
          mkdir -p .azureml
          subscription_id=$(az account show --query id -o tsv)
          echo "{
            \"subscription_id\": \"$subscription_id\",
            \"resource_group\": \"${{parameters.resourceGroup}}\",
            \"workspace_name\": \"${{parameters.amlWorkspace}}\"
          }" > .azureml/config.json

    - task: AzureCLI@1
      displayName: ${{parameters.displayName}}
      inputs:
        azureSubscription: ${{parameters.serviceConnection}}
        scriptLocation: inlineScript
        inlineScript: |
          dependencies="azureml-sdk==$(SDK_VERSION) ${{parameters.scriptExtraDependencies}}"
          python -m pip install --upgrade pip && python -m pip install $dependencies
          python ${{parameters.scriptPath}} ${{parameters.scriptArguments}}
